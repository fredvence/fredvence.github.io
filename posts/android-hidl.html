<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.119.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Android HIDL 服务实现"><meta itemprop=description content="假如生活欺骗了你"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://www.czxblog.cn/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="android,HIDL"><meta property="og:type" content="article"><meta property="og:title" content="Android HIDL 服务实现"><meta property="og:description" content="假如生活欺骗了你"><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://www.czxblog.cn/posts/android-hidl.html"><meta property="og:site_name" content="czx的小站"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="czx"><meta property="article:published_time" content="2023-11-10 08:57:46.961 +0000 UTC"><meta property="article:modified_time" content="2023-11-10 08:57:46.961 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.3daf09c888277ff84ac7ffeb504582c7a2dbb397f29ef925b1ff04ea597f069e.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"android-hidl.html","permalink":"https://www.czxblog.cn/posts/android-hidl.html","title":"Android HIDL 服务实现","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Android HIDL 服务实现 - czx的小站</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>czx的小站</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>所有你乐于挥霍的时间都不能算作浪费</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>5</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#创建hal-接口>创建HAL 接口</a></li><li><a href=#建立hidl根目录映射关系>建立HIDL根目录映射关系</a></li><li><a href=#生成模板代码>生成模板代码</a><ul><li><a href=#添加脚本update-makefilessh>添加脚本update-makefiles.sh</a></li><li><a href=#使用脚本生成hal-androidbp>使用脚本生成hal Android.bp</a></li><li><a href=#生成服务端实现代码>生成服务端实现代码</a></li><li><a href=#代码树说明>代码树说明：</a></li></ul></li><li><a href=#创建hal-service>创建hal Service</a><ul><li><a href=#验证hal-service>验证hal service</a></li></ul></li></ul><ul><li><a href=#客户端测试逻辑实现>客户端测试逻辑实现</a></li><li><a href=#验证客户端测试>验证客户端测试</a></li></ul><ul><li><a href=#添加init-rc>添加init rc</a></li><li><a href=#添加selinux-权限>添加Selinux 权限</a></li><li><a href=#打包>打包</a></li><li><a href=#更新currenttxt>更新current.txt</a></li><li><a href=#代码树结构>代码树结构</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=czx src=/imgs/img-lazy-loading.gif data-src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>czx</p><div class=site-description itemprop=description>假如生活欺骗了你</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>5</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>3</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>8</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/fredvence title="Github → https://github.com/fredvence" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2023-10-20T00:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=3908></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=11></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-12-07T15:15:53+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://www.czxblog.cn/posts/android-hidl.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="czx"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="czx"><meta itemprop=description content="假如生活欺骗了你"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Android HIDL 服务实现"><meta itemprop=description content="概述

引用Android 官方文档描述：

HAL 接口定义语言（简称 HIDL）是用于指定 HAL 和其用户之间的接口的一种接口描述语言 (IDL)。HIDL 允许指定类型和方法调用（会汇集到接口和软件包中）。从更广泛的意义上来说，HIDL 是指用于在可以独立编译的代码库之间进行通信的系统。从 Android 10 开始，HIDL 已废弃，Android 将在所有位置改用 

    AIDL
    
    
    
。
HIDL 旨在用于进程间通信 (IPC)。使用 HDL 创建的 HAL 称为绑定式 HAL，因为它们可以使用 Binder 进程间通信 (IPC) 调用与其他架构层进行通信。绑定式 HAL 在独立于使用它们的客户端的进程中运行。对于必须与进程相关联的代码库，还可以使用

    透传模式
    
    
    
（在 Java 中不受支持）。
HIDL 可指定数据结构和方法签名，这些内容会整理归类到接口（与类相似）中，而接口会汇集到软件包中。尽管 HIDL 具有一系列不同的关键字，但 C++ 和 Java 程序员对 HIDL 的语法并不陌生。此外，HIDL 还使用 Java 样式的注解
"></span><header class=post-header><h1 class=post-title itemprop="name headline">Android HIDL 服务实现</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text title=发表于>发表于：</span>
<time title="创建时间：2023-11-10 08:57:46.961 +0000 UTC" itemprop="dateCreated datePublished" datetime="2023-11-10 08:57:46.961 +0000 UTC">2023-11-10</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text title=分类于>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/android-%E6%8A%80%E6%9C%AF itemprop=url rel=index><span itemprop=name>android 技术</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span>
<span>2738</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>6分钟</span></span>
<span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>浏览：</span>
<span id=busuanzi_value_page_pv data-path=/posts/android-hidl.html><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h1 id=概述>概述
<a class=header-anchor href=#%e6%a6%82%e8%bf%b0></a></h1><p>引用Android 官方文档描述：</p><blockquote><p>HAL 接口定义语言（简称 HIDL）是用于指定 HAL 和其用户之间的接口的一种接口描述语言 (IDL)。HIDL 允许指定类型和方法调用（会汇集到接口和软件包中）。从更广泛的意义上来说，HIDL 是指用于在可以独立编译的代码库之间进行通信的系统。从 Android 10 开始，HIDL 已废弃，Android 将在所有位置改用 
<a href="https://source.android.google.cn/docs/core/architecture/aidl?hl=zh-cn" title=AIDL rel="noopener external nofollow noreferrer" target=_blank class=exturl>AIDL
<i class="fa fa-external-link-alt"></i>
</a>。</p><p>HIDL 旨在用于进程间通信 (IPC)。使用 HDL 创建的 HAL 称为绑定式 HAL，因为它们可以使用 Binder 进程间通信 (IPC) 调用与其他架构层进行通信。绑定式 HAL 在独立于使用它们的客户端的进程中运行。对于必须与进程相关联的代码库，还可以使用
<a href="https://source.android.google.cn/docs/core/architecture/hidl?hl=zh-cn#passthrough" title=透传模式 rel="noopener external nofollow noreferrer" target=_blank class=exturl>透传模式
<i class="fa fa-external-link-alt"></i>
</a>（在 Java 中不受支持）。</p><p>HIDL 可指定数据结构和方法签名，这些内容会整理归类到接口（与类相似）中，而接口会汇集到软件包中。尽管 HIDL 具有一系列不同的关键字，但 C++ 和 Java 程序员对 HIDL 的语法并不陌生。此外，HIDL 还使用 Java 样式的注解</p></blockquote><h1 id=hidl-服务端实现c>HIDL 服务端实现（C++）
<a class=header-anchor href=#hidl-%e6%9c%8d%e5%8a%a1%e7%ab%af%e5%ae%9e%e7%8e%b0c></a></h1><h2 id=创建hal-接口>创建HAL 接口
<a class=header-anchor href=#%e5%88%9b%e5%bb%bahal-%e6%8e%a5%e5%8f%a3></a></h2><p>创建目录，创建HAL 接口问题：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir vendor/czx/hardware/interfaces/hello/1.0/default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>touch vendor/czx/hardware/interfaces/hello/1.0/IHello.hal
</span></span></code></pre></div><p>在IHello.hal 中进行接口的声明：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#aa89ea>package</span> <span style=color:#aa89ea>vendor</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>czx</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>hardware</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>hello</span>@<span style=color:#d19a66>1.0</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>interface</span> <span style=color:#aa89ea>IHello</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00b1f7>hello</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>string</span> <span style=color:#aa89ea>name</span><span style=color:#abb2bf>)</span> <span style=color:#00b1f7>generates</span> <span style=color:#abb2bf>(</span><span style=color:#aa89ea>string</span> <span style=color:#aa89ea>result</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00b1f7>foo</span><span style=color:#abb2bf>(</span><span style=color:#e5c07b>int32_t</span> <span style=color:#aa89ea>a</span><span style=color:#abb2bf>,</span> <span style=color:#e5c07b>int32_t</span> <span style=color:#aa89ea>b</span><span style=color:#abb2bf>)</span> <span style=color:#00b1f7>generates</span> <span style=color:#abb2bf>(</span><span style=color:#e5c07b>int32_t</span> <span style=color:#aa89ea>result</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00b1f7>print</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>string</span> <span style=color:#aa89ea>s</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>};</span>
</span></span></code></pre></div><p>详细HAL 语法</p><p><a href="https://source.android.google.cn/docs/core/architecture/hidl-cpp/types?hl=zh-cn" title="数据类型  |  Android 开源项目  |  Android Open Source Project" rel="noopener external nofollow noreferrer" target=_blank class=exturl>数据类型  |  Android 开源项目  |  Android Open Source Project
<i class="fa fa-external-link-alt"></i></a></p><h2 id=建立hidl根目录映射关系>建立HIDL根目录映射关系
<a class=header-anchor href=#%e5%bb%ba%e7%ab%8bhidl%e6%a0%b9%e7%9b%ae%e5%bd%95%e6%98%a0%e5%b0%84%e5%85%b3%e7%b3%bb></a></h2><p>在vendor/czx/hardware/interfaces/hello/1.0目录下创建一个Android.bp文件.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#aa89ea>subdirs</span> <span style=color:#54b1c7>=</span> <span style=color:#abb2bf>[</span>
</span></span><span style=display:flex><span>    <span style=color:#98c379>&#34;*&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>hidl_package_root</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f5a40d>name</span><span style=color:#abb2bf>:</span> <span style=color:#98c379>&#34;vendor.czx.hardware&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f5a40d>path</span><span style=color:#abb2bf>:</span> <span style=color:#98c379>&#34;vendor/czx/hardware/interfaces&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>}</span>
</span></span></code></pre></div><h2 id=生成模板代码>生成模板代码
<a class=header-anchor href=#%e7%94%9f%e6%88%90%e6%a8%a1%e6%9d%bf%e4%bb%a3%e7%a0%81></a></h2><h3 id=添加脚本update-makefilessh>添加脚本update-makefiles.sh
<a class=header-anchor href=#%e6%b7%bb%e5%8a%a0%e8%84%9a%e6%9c%acupdate-makefilessh></a></h3><p>将 hardware/interfaces/update-makefiles.sh 文件拷贝一份到vendor/czx/hardware/interfaces下,</p><p>并对<code>update-makefiles.sh</code> 进行修改. 将android.hardware:hardware/interfaces 映射替换成vendor.czx.hardware:vendor/czx/hardware/interfaces.<br>这里的映射关系要与上面的hidl_package_root的映射保持一致.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>source</span> <span style=color:#dcaeea>$ANDROID_BUILD_TOP</span>/system/tools/hidl/update-makefiles-helper.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>do_makefiles_update <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>  <span style=color:#63c381>&#34;vendor.czx.hardware:vendor/czx/hardware/interfaces&#34;</span> <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>  <span style=color:#63c381>&#34;android.hidl:system/libhidl/transport&#34;</span>
</span></span></code></pre></div><h3 id=使用脚本生成hal-androidbp>使用脚本生成hal Android.bp
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8%e8%84%9a%e6%9c%ac%e7%94%9f%e6%88%90hal-androidbp></a></h3><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#执行脚本, 生成更新Andorid.bp</span>
</span></span><span style=display:flex><span>./update-makefiles.sh
</span></span></code></pre></div><h3 id=生成服务端实现代码>生成服务端实现代码
<a class=header-anchor href=#%e7%94%9f%e6%88%90%e6%9c%8d%e5%8a%a1%e7%ab%af%e5%ae%9e%e7%8e%b0%e4%bb%a3%e7%a0%81></a></h3><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#dcaeea>PACKAGE</span><span style=color:#54b1c7>=</span>vendor.czx.hardware.hello@1.0
</span></span><span style=display:flex><span><span style=color:#dcaeea>LOC</span><span style=color:#54b1c7>=</span>vendor/czx/hardware/interfaces/hello/1.0/default
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#生成Hello.h,Hello.cpp.  </span>
</span></span><span style=display:flex><span>hidl-gen -o <span style=color:#dcaeea>$LOC</span> -Lc++-impl -rvendor.czx.hardware:vendor/czx/hardware/interfaces <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>	-randroid.hidl:system/libhidl/transport <span style=color:#dcaeea>$PACKAGE</span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#生成Android.bp</span>
</span></span><span style=display:flex><span>hidl-gen -o <span style=color:#dcaeea>$LOC</span> -Landroidbp-impl -rvendor.czx.hardware:vendor/czx/hardware/interfaces <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>	-randroid.hidl:system/libhidl/transport <span style=color:#dcaeea>$PACKAGE</span>
</span></span></code></pre></div><h3 id=代码树说明>代码树说明：
<a class=header-anchor href=#%e4%bb%a3%e7%a0%81%e6%a0%91%e8%af%b4%e6%98%8e></a></h3><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>├── hello 
</span></span><span style=display:flex><span>│   └── 1.0
</span></span><span style=display:flex><span>│       ├── Android.bp //update-makefiles.sh生成
</span></span><span style=display:flex><span>│       ├── default
</span></span><span style=display:flex><span>│       │   ├── Android.bp //hidl-gen -Landroidbp-impl 相关指令生成
</span></span><span style=display:flex><span>│       │   ├── Hello.cpp //hidl-gen -Lc++-impl 相关指令生成
</span></span><span style=display:flex><span>│       │   ├── Hello.h //hidl-gen -Lc++-impl 相关指令生成
</span></span><span style=display:flex><span>│       └── IHello.hal
</span></span><span style=display:flex><span>└── update-makefiles.sh // 脚本，用于更新，生成hal 接口so
</span></span></code></pre></div><p>模板代码生成完成后， 接下来需要对Hello.cpp 添加具体功能.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#include</span> <span style=color:#8a93a5;font-style:italic>&#34;Hello.h&#34;</span><span style=color:#8a93a5;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#include</span> <span style=color:#8a93a5;font-style:italic>&lt;utils/Log.h&gt;</span><span style=color:#8a93a5;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span><span style=color:#76a9f9>namespace</span> <span style=color:#aa89ea>vendor</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>namespace</span> <span style=color:#aa89ea>czx</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>namespace</span> <span style=color:#aa89ea>hardware</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>namespace</span> <span style=color:#aa89ea>hello</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>namespace</span> <span style=color:#aa89ea>V1_0</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>namespace</span> <span style=color:#aa89ea>implementation</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>// Methods from ::vendor::czx::hardware::hello::V1_0::IHello follow.
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span><span style=color:#aa89ea>Return</span><span style=color:#54b1c7>&lt;</span><span style=color:#e5c07b>void</span><span style=color:#54b1c7>&gt;</span> <span style=color:#aa89ea>Hello</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>hello</span><span style=color:#abb2bf>(</span><span style=color:#76a9f9>const</span> <span style=color:#aa89ea>hidl_string</span><span style=color:#54b1c7>&amp;</span> <span style=color:#aa89ea>name</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>hello_cb</span> <span style=color:#aa89ea>_hidl_cb</span><span style=color:#abb2bf>)</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>ALOGD</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;Hello:hello() called&#34;</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>_hidl_cb</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>name</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#76a9f9>return</span> <span style=color:#00b1f7>Void</span><span style=color:#abb2bf>();</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>Return</span><span style=color:#54b1c7>&lt;</span><span style=color:#e5c07b>int32_t</span><span style=color:#54b1c7>&gt;</span> <span style=color:#aa89ea>Hello</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>foo</span><span style=color:#abb2bf>(</span><span style=color:#e5c07b>int32_t</span> <span style=color:#aa89ea>a</span><span style=color:#abb2bf>,</span> <span style=color:#e5c07b>int32_t</span> <span style=color:#aa89ea>b</span><span style=color:#abb2bf>)</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>     <span style=color:#aa89ea>ALOGD</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;Hello::foo() called a = %d, b = %d &#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>a</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>b</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#76a9f9>return</span> <span style=color:#e5c07b>int32_t</span> <span style=color:#abb2bf>{</span> <span style=color:#aa89ea>a</span> <span style=color:#54b1c7>+</span> <span style=color:#aa89ea>b</span> <span style=color:#abb2bf>};</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>Return</span><span style=color:#54b1c7>&lt;</span><span style=color:#e5c07b>void</span><span style=color:#54b1c7>&gt;</span> <span style=color:#aa89ea>Hello</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>print</span><span style=color:#abb2bf>(</span><span style=color:#76a9f9>const</span> <span style=color:#aa89ea>hidl_string</span><span style=color:#54b1c7>&amp;</span> <span style=color:#aa89ea>s</span><span style=color:#abb2bf>)</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>ALOGD</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;Hello::print() called a = %s &#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>s</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>c_str</span><span style=color:#abb2bf>());</span>
</span></span><span style=display:flex><span>    <span style=color:#76a9f9>return</span> <span style=color:#00b1f7>Void</span><span style=color:#abb2bf>();</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>// Methods from ::android::hidl::base::V1_0::IBase follow.
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>//IHello* HIDL_FETCH_IHello(const char* /* name */) {
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>//return new Hello();
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>//}
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span><span style=color:#abb2bf>}</span>  <span style=color:#8a93a5;font-style:italic>// namespace implementation
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span><span style=color:#abb2bf>}</span>  <span style=color:#8a93a5;font-style:italic>// namespace V1_0
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span><span style=color:#abb2bf>}</span>  <span style=color:#8a93a5;font-style:italic>// namespace hello
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span><span style=color:#abb2bf>}</span>  <span style=color:#8a93a5;font-style:italic>// namespace hardware
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span><span style=color:#abb2bf>}</span>  <span style=color:#8a93a5;font-style:italic>// namespace czx
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span><span style=color:#abb2bf>}</span>  <span style=color:#8a93a5;font-style:italic>// namespace vendor
</span></span></span></code></pre></div><p>编译：mmm vendor/czx/hardware/interfaces/hello/1.0/</p><p>通过编译会生成主要关注的so库文件：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#hal 接口so, 由客户端使用</span>
</span></span><span style=display:flex><span>out/target/product/xxxx/system/lib64/vendor.czx.hardware.hello@1.0.so
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># hal 接口功能实现，由服务端使用</span>
</span></span><span style=display:flex><span>out/target/product/xxxx/vendor/lib64/hw/vendor.czx.hardware.hello@1.0-impl.so
</span></span></code></pre></div><h2 id=创建hal-service>创建hal Service
<a class=header-anchor href=#%e5%88%9b%e5%bb%bahal-service></a></h2><p>在vendor/czx/hardware/interfaces/hello/1.0/default/ 目录下创建一个service.cpp</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#include</span> <span style=color:#8a93a5;font-style:italic>&lt;stdio.h&gt;</span><span style=color:#8a93a5;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#include</span> <span style=color:#8a93a5;font-style:italic>&lt;android/log.h&gt;</span><span style=color:#8a93a5;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#include</span> <span style=color:#8a93a5;font-style:italic>&lt;hidl/HidlTransportSupport.h&gt;</span><span style=color:#8a93a5;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#include</span> <span style=color:#8a93a5;font-style:italic>&#34;Hello.h&#34;</span><span style=color:#8a93a5;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#undef LOG_TAG
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#define LOG_TAG &#34;HelloService&#34;
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>using</span> <span style=color:#54b1c7>::</span><span style=color:#aa89ea>android</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>hardware</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>configureRpcThreadpool</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>using</span> <span style=color:#54b1c7>::</span><span style=color:#aa89ea>android</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>hardware</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>joinRpcThreadpool</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>using</span> <span style=color:#54b1c7>::</span><span style=color:#aa89ea>vendor</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>czx</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>hardware</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>hello</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>V1_0</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>implementation</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Hello</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>using</span> <span style=color:#54b1c7>::</span><span style=color:#aa89ea>vendor</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>czx</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>hardware</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>hello</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>V1_0</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>IHello</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>using</span> <span style=color:#54b1c7>::</span><span style=color:#aa89ea>android</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>status_t</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>int</span> <span style=color:#00b1f7>main</span><span style=color:#abb2bf>(</span><span style=color:#e5c07b>int</span> <span style=color:#8a93a5;font-style:italic>/*argc*/</span><span style=color:#abb2bf>,</span> <span style=color:#e5c07b>char</span> <span style=color:#54b1c7>*</span> <span style=color:#8a93a5;font-style:italic>/*argv*/</span><span style=color:#abb2bf>[])</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>android</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>sp</span><span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>IHello</span><span style=color:#54b1c7>&gt;</span> <span style=color:#aa89ea>service</span> <span style=color:#54b1c7>=</span> <span style=color:#76a9f9>new</span> <span style=color:#aa89ea>Hello</span><span style=color:#abb2bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>configureRpcThreadpool</span><span style=color:#abb2bf>(</span><span style=color:#d19a66>4</span><span style=color:#abb2bf>,</span> <span style=color:#e5c07b>true</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>ALOGD</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;Hello HAL service starting&#34;</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>status_t</span> <span style=color:#aa89ea>status</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>service</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>registerAsService</span><span style=color:#abb2bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#76a9f9>if</span> <span style=color:#abb2bf>(</span><span style=color:#aa89ea>status</span> <span style=color:#54b1c7>!=</span> <span style=color:#54b1c7>::</span><span style=color:#aa89ea>android</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>OK</span><span style=color:#abb2bf>)</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#aa89ea>ALOGE</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;Unable to register Hello HAL service (%d)&#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>status</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>        <span style=color:#76a9f9>return</span> <span style=color:#d19a66>1</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#abb2bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>ALOGI</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;Register Hello HAL Service successfully&#34;</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>joinRpcThreadpool</span><span style=color:#abb2bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#76a9f9>return</span> <span style=color:#d19a66>0</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>}</span>
</span></span></code></pre></div><p>在default 目录下Android.bp中添加cc_binary:</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cc_binary <span style=color:#54b1c7>{</span>
</span></span><span style=display:flex><span>    name: <span style=color:#63c381>&#34;vendor.czx.hardware.hello@1.0-service&#34;</span>,
</span></span><span style=display:flex><span>    relative_install_path: <span style=color:#63c381>&#34;hw&#34;</span>,
</span></span><span style=display:flex><span>    proprietary: true,
</span></span><span style=display:flex><span>    srcs: <span style=color:#54b1c7>[</span>
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;service.cpp&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;Hello.cpp&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#54b1c7>]</span>,
</span></span><span style=display:flex><span>    shared_libs: <span style=color:#54b1c7>[</span>
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;libhidlbase&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;libhidltransport&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;libutils&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;liblog&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;vendor.czx.hardware.hello@1.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#54b1c7>]</span>,
</span></span><span style=display:flex><span><span style=color:#54b1c7>}</span>
</span></span></code></pre></div><p>编译生成:</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>out/target/product/xxxx/vendor/bin/hw/vendor.czx.hardware.hello@1.0-service
</span></span></code></pre></div><h3 id=验证hal-service>验证hal service
<a class=header-anchor href=#%e9%aa%8c%e8%af%81hal-service></a></h3><p>到此，我们可以将编译出来的产物push 到Android 设备中，</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>adb push vendor.czx.hardware.hello@1.0-service vendor/bin/hw/
</span></span><span style=display:flex><span>adb push vendor.czx.hardware.hello@1.0-impl.so vendor/lib64/hw/
</span></span><span style=display:flex><span>adb push vendor.czx.hardware.hello@1.0.so vendor/lib64/
</span></span></code></pre></div><p>启动hal service , 打印日志，观察hal service 是否启动成功</p><p><img src=/imgs/img-lazy-loading.gif data-src=http://images.czxblog.cn/static/imgs/20231109162349.png alt></p><h1 id=hidl-客户端实现>HIDL 客户端实现
<a class=header-anchor href=#hidl-%e5%ae%a2%e6%88%b7%e7%ab%af%e5%ae%9e%e7%8e%b0></a></h1><h2 id=客户端测试逻辑实现>客户端测试逻辑实现
<a class=header-anchor href=#%e5%ae%a2%e6%88%b7%e7%ab%af%e6%b5%8b%e8%af%95%e9%80%bb%e8%be%91%e5%ae%9e%e7%8e%b0></a></h2><p>创建test 目录，Hello_test.cpp, Android.bp</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir vendor/czx/hardware/interfaces/hello/1.0/default/test/
</span></span><span style=display:flex><span>touch vendor/czx/hardware/interfaces/hello/1.0/default/test/Hello_test.cpp
</span></span><span style=display:flex><span>touch vendor/czx/hardware/interfaces/hello/1.0/default/test/Android.bp
</span></span></code></pre></div><p>实现Hello_test.cpp 测试逻辑, 获取IHello 服务. 调用IHello hal接口</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#include</span> <span style=color:#8a93a5;font-style:italic>&lt;vendor/czx/hardware/hello/1.0/IHello.h&gt;</span><span style=color:#8a93a5;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#include</span> <span style=color:#8a93a5;font-style:italic>&lt;log/log.h&gt;</span><span style=color:#8a93a5;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>using</span> <span style=color:#aa89ea>android</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>sp</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>using</span> <span style=color:#aa89ea>android</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>hardware</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>hidl_string</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>using</span> <span style=color:#54b1c7>::</span><span style=color:#aa89ea>vendor</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>czx</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>hardware</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>hello</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>V1_0</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>IHello</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>int</span> <span style=color:#00b1f7>main</span><span style=color:#abb2bf>()</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>		<span style=color:#8a93a5;font-style:italic>//获取IHello 服务.
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#aa89ea>sp</span><span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>IHello</span><span style=color:#54b1c7>&gt;</span> <span style=color:#aa89ea>service</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>IHello</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>getService</span><span style=color:#abb2bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#76a9f9>if</span> <span style=color:#abb2bf>(</span><span style=color:#aa89ea>service</span> <span style=color:#54b1c7>==</span> <span style=color:#76a9f9>nullptr</span><span style=color:#abb2bf>)</span>
</span></span><span style=display:flex><span>    <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#aa89ea>ALOGE</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;HELLO_TEST: Can&#39;t find IHello service...&#34;</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>        <span style=color:#76a9f9>return</span> <span style=color:#54b1c7>-</span><span style=color:#d19a66>1</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#abb2bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>printf</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;HELLO_TEST: found service @ %p</span><span style=color:#d26464;font-weight:700>\n</span><span style=color:#98c379>&#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>service</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>get</span><span style=color:#abb2bf>());</span>
</span></span><span style=display:flex><span>		<span style=color:#8a93a5;font-style:italic>//通过IHello 实例，调用其接口.
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#aa89ea>service</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>hello</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;test_client&#34;</span><span style=color:#abb2bf>,</span> <span style=color:#abb2bf>[</span><span style=color:#54b1c7>&amp;</span><span style=color:#abb2bf>](</span><span style=color:#aa89ea>hidl_string</span> <span style=color:#aa89ea>result</span><span style=color:#abb2bf>)</span>
</span></span><span style=display:flex><span>                   <span style=color:#abb2bf>{</span> <span style=color:#aa89ea>printf</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;HELLO_TEST: %s</span><span style=color:#d26464;font-weight:700>\n</span><span style=color:#98c379>&#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>result</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>c_str</span><span style=color:#abb2bf>());</span> <span style=color:#abb2bf>});</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>service</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>foo</span><span style=color:#abb2bf>(</span><span style=color:#d19a66>10</span><span style=color:#abb2bf>,</span> <span style=color:#d19a66>4</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>service</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>print</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;Hello HIDL&#34;</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#76a9f9>return</span> <span style=color:#d19a66>0</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>}</span>
</span></span></code></pre></div><p>添加编译规则, 进行编译，将在out/target/product/xxxx/vendor/bin/hw/生成一个可执行bin 文件Hello_test</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#aa89ea>cc_binary</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f5a40d>name</span><span style=color:#abb2bf>:</span> <span style=color:#98c379>&#34;Hello_test&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f5a40d>relative_install_path</span><span style=color:#abb2bf>:</span> <span style=color:#98c379>&#34;hw&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f5a40d>proprietary</span><span style=color:#abb2bf>:</span> <span style=color:#e5c07b>true</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f5a40d>srcs</span><span style=color:#abb2bf>:</span> <span style=color:#abb2bf>[</span><span style=color:#98c379>&#34;Hello_test.cpp&#34;</span><span style=color:#abb2bf>],</span>
</span></span><span style=display:flex><span>    <span style=color:#f5a40d>shared_libs</span><span style=color:#abb2bf>:</span> <span style=color:#abb2bf>[</span>
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#34;liblog&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#34;libhidlbase&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#34;libhidltransport&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#34;libhwbinder&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#34;libutils&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>         <span style=color:#98c379>&#34;vendor.czx.hardware.hello@1.0&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#abb2bf>],</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>}</span>
</span></span></code></pre></div><h2 id=验证客户端测试>验证客户端测试
<a class=header-anchor href=#%e9%aa%8c%e8%af%81%e5%ae%a2%e6%88%b7%e7%ab%af%e6%b5%8b%e8%af%95></a></h2><p>将编译生成的bin文件push 到Android 设备</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>adb push Hello_test vendor/bin/hw
</span></span></code></pre></div><p>启动IHello 服务 并执行Hello_test</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>./vendor.czx.hardware.hello@1.0-service <span style=color:#abb2bf>|</span> ./Hello_test
</span></span></code></pre></div><p>从日志中可以看见, hwservicemanager 找不到IHello这个服务. 这是因为没有在VINTF 清单进行声明.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>01-01 06:33:10.414   <span style=color:#d19a66>298</span>   <span style=color:#d19a66>298</span> W hwservicemanager: getTransport: Cannot find entry vendor.czx.hardware.hello@1.0::IHello/default in either framework or device manifest.
</span></span><span style=display:flex><span>01-01 06:33:10.415  <span style=color:#d19a66>8759</span>  <span style=color:#d19a66>8759</span> E HELLO_TEST: Can&#39;t find IHello service...
</span></span></code></pre></div><p>将修改后清单文件重新push 到Android 设备, 重启，重新验证客户端测试</p><p>Hello_test 可以正常获取到IHello 服务，并调用其hal 接口.</p><p><img src=/imgs/img-lazy-loading.gif data-src=http://images.czxblog.cn/static/imgs/20231109183213.png alt></p><h1 id=vintf-清单声明>VINTF 清单声明
<a class=header-anchor href=#vintf-%e6%b8%85%e5%8d%95%e5%a3%b0%e6%98%8e></a></h1><p>将Android 设备中的清单文件pull 出来，修改，然后验证. 最后在项目中的manifest.xml下添加IHello的声明.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#aa89ea>adb</span> <span style=color:#aa89ea>pull</span> <span style=color:#aa89ea>vendor</span><span style=color:#54b1c7>/</span><span style=color:#aa89ea>etc</span><span style=color:#54b1c7>/</span><span style=color:#aa89ea>vintf</span><span style=color:#54b1c7>/</span><span style=color:#aa89ea>manifest</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>xml</span>
</span></span></code></pre></div><p>在清单文件中添加对IHello 的声明:</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>hal</span> <span style=color:#aa89ea>format</span><span style=color:#54b1c7>=</span><span style=color:#98c379>&#34;hidl&#34;</span><span style=color:#54b1c7>&gt;</span> 
</span></span><span style=display:flex><span>    <span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>name</span><span style=color:#54b1c7>&gt;</span><span style=color:#aa89ea>vendor</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>czx</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>hardware</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>hello</span><span style=color:#54b1c7>&lt;/</span><span style=color:#aa89ea>name</span><span style=color:#54b1c7>&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>transport</span><span style=color:#54b1c7>&gt;</span><span style=color:#aa89ea>hwbinder</span><span style=color:#54b1c7>&lt;/</span><span style=color:#aa89ea>transport</span><span style=color:#54b1c7>&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>version</span><span style=color:#54b1c7>&gt;</span><span style=color:#d19a66>1.0</span><span style=color:#54b1c7>&lt;/</span><span style=color:#aa89ea>version</span><span style=color:#54b1c7>&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>interface</span><span style=color:#54b1c7>&gt;</span> 
</span></span><span style=display:flex><span>      <span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>name</span><span style=color:#54b1c7>&gt;</span><span style=color:#aa89ea>IHello</span><span style=color:#54b1c7>&lt;/</span><span style=color:#aa89ea>name</span><span style=color:#54b1c7>&gt;</span>  
</span></span><span style=display:flex><span>      <span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>instance</span><span style=color:#54b1c7>&gt;</span><span style=color:#76a9f9>default</span><span style=color:#54b1c7>&lt;/</span><span style=color:#aa89ea>instance</span><span style=color:#54b1c7>&gt;</span> 
</span></span><span style=display:flex><span>    <span style=color:#54b1c7>&lt;/</span><span style=color:#aa89ea>interface</span><span style=color:#54b1c7>&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>fqname</span><span style=color:#54b1c7>&gt;</span>@<span style=color:#d19a66>1.0</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>IHello</span><span style=color:#54b1c7>/</span><span style=color:#76a9f9>default</span><span style=color:#54b1c7>&lt;/</span><span style=color:#aa89ea>fqname</span><span style=color:#54b1c7>&gt;</span> 
</span></span><span style=display:flex><span><span style=color:#54b1c7>&lt;/</span><span style=color:#aa89ea>hal</span><span style=color:#54b1c7>&gt;</span>
</span></span></code></pre></div><p>关于VINTF清单见：
<a href="https://source.android.google.cn/docs/core/architecture/vintf/objects?hl=zh-cn" title="清单  |  Android 开源项目  |  Android Open Source Project (google.cn)" rel="noopener external nofollow noreferrer" target=_blank class=exturl>清单  |  Android 开源项目  |  Android Open Source Project (google.cn)
<i class="fa fa-external-link-alt"></i></a></p><p>如果</p><h1 id=如何让hal-service-在系统中正确启动>如何让hal service 在系统中正确启动
<a class=header-anchor href=#%e5%a6%82%e4%bd%95%e8%ae%a9hal-service-%e5%9c%a8%e7%b3%bb%e7%bb%9f%e4%b8%ad%e6%ad%a3%e7%a1%ae%e5%90%af%e5%8a%a8></a></h1><h2 id=添加init-rc>添加init rc
<a class=header-anchor href=#%e6%b7%bb%e5%8a%a0init-rc></a></h2><p>添加rc文件, 目的在开机时启动hal service.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>service vendor.hello /vendor/bin/hw/vendor.czx.hardware.hello@1.0-service
</span></span><span style=display:flex><span>    class hal
</span></span><span style=display:flex><span>    user system
</span></span><span style=display:flex><span>    group system
</span></span></code></pre></div><p>修改Android.bp, 添加init_rc: [&ldquo;vendor.czx.hardware.hello@1.0-service.rc&rdquo;],</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cc_binary <span style=color:#54b1c7>{</span>
</span></span><span style=display:flex><span>    name: <span style=color:#63c381>&#34;vendor.czx.hardware.hello@1.0-service&#34;</span>,
</span></span><span style=display:flex><span>    relative_install_path: <span style=color:#63c381>&#34;hw&#34;</span>,
</span></span><span style=display:flex><span>    init_rc: <span style=color:#54b1c7>[</span><span style=color:#63c381>&#34;vendor.czx.hardware.hello@1.0-service.rc&#34;</span><span style=color:#54b1c7>]</span>,
</span></span><span style=display:flex><span>    proprietary: true,
</span></span><span style=display:flex><span>    srcs: <span style=color:#54b1c7>[</span>
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;service.cpp&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;Hello.cpp&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#54b1c7>]</span>,
</span></span><span style=display:flex><span>    shared_libs: <span style=color:#54b1c7>[</span>
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;libhidlbase&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;libhidltransport&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;libutils&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;liblog&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;vendor.czx.hardware.hello@1.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#54b1c7>]</span>,
</span></span><span style=display:flex><span><span style=color:#54b1c7>}</span>
</span></span></code></pre></div><p>但仅仅添加rc, 不能让服务正常启动，系统在启动时会进行Selinux 权限检查。 所以需要为其添加Selinux 权限.</p><blockquote><p>01-01 08:00:03.341 0 0 E [kernel]init: Could not start service &lsquo;vendor.hello&rsquo; as part of class &lsquo;hal&rsquo;: File /vendor/bin/hw/vendor.czx.hardware.hello@1.0-service(labeled &ldquo;u:object_r:vendor_file:s0&rdquo;) has incorrect label or no domain transition from u:r:init:s0 to another SELinux domain defined. Have you configured your service correctly?
<a href=https://source.android.com/security/selinux/device-policy#label_new_services_and_address_denials title=https://source.android.com/security/selinux/device-policy#label_new_services_and_address_denials rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://source.android.com/security/selinux/device-policy#label_new_services_and_address_denials
<i class="fa fa-external-link-alt"></i></a></p></blockquote><h2 id=添加selinux-权限>添加Selinux 权限
<a class=header-anchor href=#%e6%b7%bb%e5%8a%a0selinux-%e6%9d%83%e9%99%90></a></h2><p>在device/xxxx/sepolicy目录下，新增hal_hello.te 文件</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># hello service</span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>type</span> hal_hello, domain<span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>type</span> hal_hello_exec, exec_type, vendor_file_type,  file_type<span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hwbinder_use<span style=color:#54b1c7>(</span>hal_hello<span style=color:#54b1c7>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>init_daemon_domain<span style=color:#54b1c7>(</span>hal_hello<span style=color:#54b1c7>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add_hwservice<span style=color:#54b1c7>(</span>hal_hello, hal_hello_hwservice<span style=color:#54b1c7>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>get_prop<span style=color:#54b1c7>(</span>hal_hello, hwservicemanager_prop<span style=color:#54b1c7>)</span>
</span></span></code></pre></div><p>在file_contexts文件中添加：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#hello service</span>
</span></span><span style=display:flex><span>/<span style=color:#54b1c7>(</span>vendor<span style=color:#abb2bf>|</span>system/vendor<span style=color:#54b1c7>)</span>/bin/hw/vendor<span style=color:#d26464;font-weight:700>\.</span>czx<span style=color:#d26464;font-weight:700>\.</span>hardware<span style=color:#d26464;font-weight:700>\.</span>hello@1<span style=color:#d26464;font-weight:700>\.</span>0-service u:object_r:hal_hello_exec:s0
</span></span></code></pre></div><p>在hwservice_contexts文件中添加：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>vendor.czx.hardware.hello::IHello             u:object_r:hal_hello_hwservice:s0
</span></span></code></pre></div><p>在hwservice.te 文件中添加：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#e5c07b>type</span> hal_hello_hwservice, hwservice_manager_type<span style=color:#abb2bf>;</span>
</span></span></code></pre></div><h2 id=打包>打包
<a class=header-anchor href=#%e6%89%93%e5%8c%85></a></h2><p>将hello 相关编译产物打包进系统镜像</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#dcaeea>PRODUCT_PACKAGES</span> <span style=color:#54b1c7>+=</span> <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>      vendor.czx.hardware.hello@1.0-service <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>			vendor.czx.hardware.hello@1.0 <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>			vendor.czx.hardware.hello@1.0-impl <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>			
</span></span></code></pre></div><h2 id=更新currenttxt>更新current.txt
<a class=header-anchor href=#%e6%9b%b4%e6%96%b0currenttxt></a></h2><p>当HAL 接口稳定后，进行接口发布时，请更新current.txt. 在interfaces目录下创建current.txt，填写一个任意值</p><p>和接口名。 如下：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#d19a66>8989222</span> vendor.czx.hardware.hello@1.0::IHello
</span></span></code></pre></div><p>然后执行./update-makefiles.sh。 将会给出正确的hash 值，用此hash 替换掉原来的任意值即可.</p><blockquote><p>以后HAL 接口更新时，请更新current.txt. 将新的hash 追加到current.txt 中即可.</p></blockquote><h2 id=代码树结构>代码树结构
<a class=header-anchor href=#%e4%bb%a3%e7%a0%81%e6%a0%91%e7%bb%93%e6%9e%84></a></h2><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>.
</span></span><span style=display:flex><span>└── interfaces
</span></span><span style=display:flex><span>├── current.txt 
</span></span><span style=display:flex><span>├── hello
</span></span><span style=display:flex><span>│   └── 1.0
</span></span><span style=display:flex><span>│       ├── Android.bp
</span></span><span style=display:flex><span>│       ├── default
</span></span><span style=display:flex><span>│       │   ├── Android.bp
</span></span><span style=display:flex><span>│       │   ├── Hello.cpp
</span></span><span style=display:flex><span>│       │   ├── Hello.h
</span></span><span style=display:flex><span>│       │   ├── service.cpp
</span></span><span style=display:flex><span>│       │   ├── <span style=color:#e5c07b>test</span>
</span></span><span style=display:flex><span>│       │   │   ├── Android.bp
</span></span><span style=display:flex><span>│       │   │   └── Hello_test.cpp
</span></span><span style=display:flex><span>│       │   └── vendor.czx.hardware.hello@1.0-service.rc
</span></span><span style=display:flex><span>│       └── IHello.hal
</span></span><span style=display:flex><span>└── update-makefiles.sh
</span></span></code></pre></div></div><footer class=post-footer><div class=post-tags><a href=/tags/android>android</a>
<a href=/tags/hidl>HIDL</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Android HIDL 服务实现</li><li class=post-copyright-author><strong>本文作者：</strong>
czx</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://www.czxblog.cn/posts/android-hidl.html title="Android HIDL 服务实现">https://www.czxblog.cn/posts/android-hidl.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>
本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2023-12-07-mac-wifi-no-network.html rel=next title="Mac WIFI 网络无法上网"><i class="fa fa-chevron-left"></i> Mac WIFI 网络无法上网</a></div><div class="post-nav-prev post-nav-item"><a href=/posts/ssh-login.html rel=prev title="SSH 免密登录远程机器">SSH 免密登录远程机器
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>czx</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.119.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://www.czxblog.cn","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0c78e5a4df586ee46d02716ffa91a4a322e56763e04e91eb2ba052c9469ed02.js defer></script></body></html>